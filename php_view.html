<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>view.php</title>
</head>
<body>
<b>roll.php</b><br>
session_start(); //старт сессии<br>
error_reporting(-1);<br>
ini_set("display_errors", 1);  // ошибки<br>
$id = $_SESSION['user']['id'];  // получаю id юзера<br><br>

$case = $_POST["name"];  //достаю название кейса по которому кликнули из массива POST<br><br>

include("db.php");  //подключение к БД<br><br>

$rare = ""; //создаю переменную редкость предмета<br>
$rollRare = mt_rand(0,1000)/10; // определяю предмет какой редкости получит юзер, делю на 10 чтобы получить FLOAT<br>
if($rollRare <= 92){ <br>
  $rare = "#2196f3"; // синий<br>
} else if($rollRare >=92.1 && $rollRare <=97){<br>
  $rare = "#8847ff"; // фиол<br>
} else if($rollRare >=97.1 && $rollRare <=99){<br>
  $rare = "#d32ce6"; //розовый<br>
} else if($rollRare >=99.1 && $rollRare <=99.7){<br>
  $rare = "#eb4b4b"; //красный<br>
} else $rare = "#FFD700"; //золотой(нож, перчатки)<br><br>

$req = $db->query("SELECT id, name, img FROM caseItems WHERE caseName='$case' AND rare='$rare'"); //запрос в БД( дать из таблицы вещей вещи с нужным цветом и относящиеся к кейсу который выбрал пользователь )<br> 
$arrItems = $req->fetch_all(); //ответ превращаю в индексированный массив, люблю индексированные массивы<br> 
$numItems = count($arrItems); //узнаю длину массива<br>
$randItem = rand(0,$numItems-1); //случайное число от 0 до длины массива<br>
$prize = $arrItems[$randItem]; //получаю эту строку из массива,это вещь которую выиграл юзер ( массив в виде: id вещи, название, сслылка на картинку )<br>
$prizeId = $prize[0]; //получаю id этой вещи<br><br>

$req2 = $db->query("INSERT INTO Inventory(id_user, id_item) VALUES ('$id', '$prizeId')"); //вставляю в таблицу с инвентарем пользователей новую строку с id пользователя и id вещи<br>
array_shift($prize); //удаляю 0 элемент в котором хранится id вещи, тк он мне не нужен в JS<br>
$prize[] = $rare; //добавляю новый элемент в конец массива в котором редкость вещи ( что бы не тянуть из БД данные которые уже и так получены )<br>
if($req2) print_r(json_encode($prize)); //если вещь была добавлена в инвентарь, возвращаю массив кодируя его в понятный JSу формат<br>
else print ROLL_ERROR;<br>

<br><br><br>
<b>case_view.php</b><br>
$req = $db->query("SELECT name, img, rare FROM caseItems WHERE caseName='$case'");<br>
while(($items = $req->fetch_assoc()) != null){<br>
  $name = $items["name"];<br>
  $url = $items["img"];<br>
  $rare = $items["rare"];<br>
  print "div style='background-color: $rare'>";<br>
    print "img src='$url' alt='$name'>";<br>
    print "span>$name/span>";<br>
  print "/div>";<br>
}<br>

<br><br><br>
<b>inventory.php</b><br>
$req = $db->query("SELECT name, img, rare FROM Inventory JOIN gameUser ON id_user=gameUser.id JOIN caseItems ON id_item=caseItems.id WHERE id_user='$id' ORDER BY Inventory.id DESC");<br>
while(($items = $req->fetch_assoc()) != null){<br>
  $name = $items["name"];<br>
  $url = $items["img"];<br>
  $rare = $items["rare"];<br>
  print "div style='border: 2px solid $rare'>";<br>
    print "img src='$url' alt='$name'>";<br>
    print "span>$name/span>";<br>
  print "/div>";<br>
}
      
<br><br><br>
<b>auth_obr.php</b><br>
session_start();<br>
error_reporting(-1);<br>
ini_set("display_errors", 1);<br><br>

$login = $_POST["login"];<br>
$password = $_POST["password"];<br><br>

include("db.php");<br>

$req = $db->query("SELECT * FROM gameUser WHERE login='$login' AND password='$password'");<br>
$user = $req->fetch_assoc();<br><br>

if($user){<br>
  $_SESSION['user'] = $user;<br>
  print "AUTH_OK";<br>
} else {<br>
  print "AUTH_FALSE";<br>
}<br>
<br><br><br>
<b>db.php</b><br>
$dbname = "имя БД";<br>
$dbuser = $dbname;<br>
$dbpassword = "пароль БД";<br>
$ip = "localhost"; // 128.0.0.1<br><br>

$db = new mysqli($ip, $dbuser, $dbpassword, $dbname);<br>

<br><br><br>
<b>reg_obr.php</b><br>
session_start();<br>
error_reporting(-1);<br>
ini_set("display_errors", 1);<br><br>

$login = $_POST["login"];<br>
$password = $_POST["password"];<br><br>


include("db.php");<br><br>

$req = $db->query("INSERT INTO gameUser(`login`, `password`) VALUES ('$login','$password')");<br><br>

if ($req){<br>
  /*$inv = $db->query("CREATE TABLE `$dbname`.`$login` ( `id` INT(10) UNSIGNED NOT NULL AUTO_INCREMENT , `items` VARCHAR(25) NOT NULL , PRIMARY KEY (`id`)) ENGINE = InnoDB;");*/<br>
  print "REG_OK";<br>
}else{<br>
  print "REG_FALSE";<br>
}<br>

<br><br><br>
<b>exit.php</b><br>
session_start();<br>
session_destroy();<br><br>
</body>
</html>
